<!DOCTYPE html>
<html>
<head>
<title>Federal Contracting in Hampton Roads</title>
<meta charset="utf-8">
<style>

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }
    
    .bar {
      fill: steelblue;
    }


    .selected {
        opacity: 0.7;
    }

    .subunit-boundary {
        fill: none;
        stroke: #777;
        stroke-width: 2px;
        stroke-dasharray: 2,2;
        stroke-linejoin: round;
    }

    .subunit-label {
        fill: #fff;
        font-size: 12px;
        font-weight: 300;
        text-anchor: middle;
        text-shadow:
          -2px 0px 0 #000,
          0px -2px 0 #000,
          0px 2px 0 #000,
          2px 0px 0 #000;
    }

    .cptooltip {
        position: absolute;
        width: 220px;
        height: 40px;
        pointer-events: none;
        background-color: #ffffee;
        font-family: Helvetica, Sans;
        text-align: center;
    }

    .bartooltip {
        position: absolute;
        width: 220px;
        height: 120px;
        pointer-events: none;
        background-color: #ffffee;
        font-family: Helvetica, Sans;
        text-align: center;
    }

    body {
        font-family: Helvetica, Sans;
    }

    .x.axis path {
      display: none;
    }
    
    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 1.5px;
    }

    .overlay {
      fill: none;
      pointer-events: all;
    }
    
    .focus circle {
      fill: none;
      stroke: steelblue;
    }

</style>
</head>

<body>
<h1>Federal Contracting in Hampton Roads</h1>
<h2>by Shawn Jones and Valentina Neblitt-Jones</h2>

<script src="libs/jquery/jquery-1.11.2.min.js"></script>
<script src="libs/d3/d3.v3.min.js"></script>
<script src="libs/topojson/topojson.v1.min.js"></script>
<script src="libs/colorbrewer/colorbrewer.js"></script>
<script>

    var formBlock = d3.select("body").append("p").append("form").attr("id", "axes");

    var yearoptions = formBlock.append("label").text("Year")
      .append("select").attr("id", "year").attr("class", "yearSelector");
    
    formBlock.append("br");

    var agencyoptions = formBlock.append("label").text("Agency")
      .append("select").attr("id", "agency").attr("class", "agencySelector");

    var projection = d3.geo.albers()
                        .center([0, 36.85])
                        .rotate([76.5, 0])
                        .parallels([36.5, 37.5])
                        .scale(24000)
                        .translate([360, 334]);

    var path = d3.geo.path()
                .projection(projection);


    var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = 620 - margin.left - margin.right,
        height = 490 - margin.top - margin.bottom;


    var upperchartwidth = 2 * width;
    var upperchartheight = 60 - margin.top - margin.bottom;

    var upperchart = d3.select("body").append("div");

    var linesvg = upperchart.append("svg")
                .attr("id", "linesvg")
                .attr("width", upperchartwidth + margin.left + margin.right)
                .attr("height", upperchartheight + margin.top + margin.bottom) 
                .attr("style", "background-color: #eeeeee")
                .append("g").attr("id", "linechart")
                .attr("transform", "translate(150, 20)");

    var lowercharts = d3.select("body").append("div");

    var cpsvg = lowercharts.append("svg")
                .attr("id", "cpsvg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("style", "background-color: #eeeeee")
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var barsvg = lowercharts.append("svg")
                .attr("id", "barsvg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .attr("style", "background-color: #ffffff")
                .append("g").attr("id", "barchart")
                .attr("transform", "translate(150, 20)");
                //.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // add the tooltip area to the webpage
    var cptooltip = d3.select("body").append("div")
        .attr("class", "cptooltip")
        .style("opacity", 0);

    var bartooltip = d3.select("body").append("div")
        .attr("class", "bartooltip")
        .style("opacity", 0);

    var years = new Array(); 
    var agencies = new Array();

    d3.json("data/maps/hrCounties-topo.json", function(error1, hr) {
        if (error1) return console.error(error1);

        d3.tsv("data/financials/financials.csv", function(error2, findata) {
            if (error2) return console.error(error2);

            // intialize funding and color
            for (var j = 0; j < hr.objects.hrCounties.geometries.length; j++) {
                hr.objects.hrCounties.geometries[j].properties.funding = 0; 
                hr.objects.hrCounties.geometries[j].properties.color = "#edf8e9";
            }

            yearSet = "2014";
            agencySet = "ALL";

            // initialize drop downs
            for (var i = 0; i < findata.length; i++) {

                if (jQuery.inArray(findata[i].year, years) === -1) {
                    years[years.length] = findata[i].year;
                }

                if (jQuery.inArray(findata[i].agency, agencies) === -1) {
                    agencies[agencies.length] = findata[i].agency;
                }

            }

            // sort the years
            years.sort().reverse();
            agencies.sort();

            for (var i = 0; i < years.length; i++) {
                yearoptions.append("option").text(years[i])
                    .attr("value", years[i]).attr("selected"); 
            }

            for (var i = 0; i < agencies.length; i++) {
                agencyoptions.append("option").text(agencies[i])
                    .attr("value", agencies[i]).attr("selected");
            }

            var agencyChange = function(d, id) {
                agencySet = d3.event.target.value; 
                drawChoropleth();
                drawBarchart();
                drawLinechart();
            }

            var yearChange = function(d, id) {
                yearSet = d3.event.target.value; 
                drawChoropleth();
                drawBarchart();
                drawLinechart();
            }

            d3.select("#agency").on("change", agencyChange);
            d3.select("#year").on("change", yearChange);

            drawChoropleth();
            drawBarchart();
            drawLinechart();

            function fetchColor(value) {

                if (value <= 0) {
                    color = "#edf8e9";
                } else if (value < 500000) { 
                    color = "#bae4b3";
                } else if (value < 2000000) {
                    color = "#74c476";
                } else if (value < 8000000) {
                    color = "#31a354";
                } else {
                    color = "#006d2c";
                }

                return color;
            }

            function drawChoropleth() {

                // initialize all values to 0
                for (var j = 0; j < hr.objects.hrCounties.geometries.length; j++) {
                    hr.objects.hrCounties.geometries[j].properties.funding = 0;    
                }

                // set all funding and color for localities in choropleth
                for (var i = 0; i < findata.length; i++) {
                    for (var j = 0; j < hr.objects.hrCounties.geometries.length; j++) {
    
                        if (findata[i].industry == "ALL") { 
                            if (findata[i].locality != "ALL") {
    
                                if (findata[i].year == yearSet) {
                                   
                                    if (findata[i].agency == agencySet) {
    
                                        if (findata[i].locality == hr.objects.hrCounties.geometries[j].properties.name) {
                                            hr.objects.hrCounties.geometries[j].properties.funding = findata[i].funding; 
                                            break; // stop since we made our match
                                        }
                                    }
    
                                }
                            }
                        }
                    }
                }

                cpsvg.append("text")
                    .attr("x", (width / 2) )
                    .attr("y", 0 - (margin.top / 4) + 20)
                    .attr("text-anchor", "middle")  
                    .style("font-size", "20px") 
                    .text("Geography of Funding");
    
                var subunits = cpsvg.selectAll(".subunit")
                    .data(topojson.feature(hr, hr.objects.hrCounties).features)
                    .enter().append("path")
                    .attr("style", function(d) {
                            return "fill:" + fetchColor(d.properties.funding);
                        })
                    .attr("d", path)
                    .on("mouseover", function(d, i) {
                        d3.select(this).attr("class", "selected");
                        cptooltip.transition()
                                .duration(200)
                                .style("opacity", .9);

                        format = d3.format("0,000");
                        displayFunding = format(d.properties.funding);
    
                        cptooltip.html(d.properties.name + "<br />$" + displayFunding)
                             .style("left", (d3.event.pageX + 10) + "px")
                             .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d, i) {
                        d3.select(this).attr("class", function(d) { return "subunit" + d.id; })
                        cptooltip.transition()
                             .duration(500)
                             .style("opacity", 0);
                    })
                    .on("mousemove", function(d, i) {
                        d3.select(this).attr("class", "selected");
                    });
                    /*
                    .on("click", function(d, i) {
                        window.alert("You clicked on " + d.properties.name);
                    });
                    */
       
                // create the boundaries
                cpsvg.append("path")
                    .datum(topojson.mesh(hr, hr.objects.hrCounties), function (a, b) { return a!=b; })
                    .attr("d", path)
                    .attr("class", "subunit-boundary");

                colors = d3.scale.ordinal()
                    .domain( [ "<= $0", "$0 - $500,000", "$500,000 - $2,000,000", "$2,000,000 - $8,000,000", "> $8,000,000" ] )
                    .range(colorbrewer.Greens[5]);

                var legend = cpsvg.selectAll(".legend")
                    .data( colors.domain() )
                    .enter().append("g")
                    .attr("class", "legend")
                    .attr("transform", function(d, i) {
                        return "translate(-369," + (i+2) * 20 + ")"; }
                        );

                legend.append("rect")
                    .attr("x", width - 18)
                    .attr("width", 18)
                    .attr("height", 18)
                    .style("fill", colors );


                // draw legend text
                legend.append("text")
                    .attr("x", width - 24)
                    .attr("y", 9)
                    .attr("dy", ".35em")
                    .style("text-anchor", "end")
                    .text(function(d) { return d; });

            }

            function drawBarchart() {

                var bardata = new Array();

                // clear the chart
                d3.select("#barchart").selectAll("*").remove();

                // select just the data we want
                for (var i = 0; i < findata.length; i++) {

                    if (findata[i].industry != "ALL") {
                        if (findata[i].year == yearSet) {
                            if (findata[i].agency == agencySet) {
    
                                if (findata[i].locality == "ALL") {
                                    industry = findata[i].industry;
                                    funding = findata[i].funding;
                                    locality = findata[i].locality;
                                    agency = findata[i].agency;
                                    year = findata[i].year;
    
                                    barobj = { "Industry" : industry, "Funding" : funding, "Locality" : locality, "Year" : year, "Agency" : agency };
                                    bardata[bardata.length] = barobj;
                                }
                            }
                        }
                    }
                }

                console.log(bardata.length);

                if (bardata.length > 0) {

                    bardata.sort(function(a, b) {
                        return a.Funding - b.Funding;
                    });

                    bardata.reverse();

                    bardataTop5 = new Array();

                    if (bardata.length >= 5) {
                        topN = 5;
                    } else {
                        topN = bardata.length;
                    }

                    for (var i = 0; i < topN; i++) {
                        bardataTop5[bardataTop5.length] = bardata[i];
                    }

                    var x = d3.scale.ordinal()
                        .rangeRoundBands([0, width - 200], .1);
                    
                    var y = d3.scale.linear()
                        .range([height, 0]);
                    
                    var xAxis2 = d3.svg.axis()
                        .scale(x)
                        .orient("bottom");
                    
                    var commasFormatter = d3.format("$,.0f");

                    var yAxis2 = d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .ticks(10, "$,.2f");

                    x.domain(bardataTop5.map(function(d) { return d.Industry; }));
                    y.domain([ 0, bardataTop5[0].Funding ]);

                    // all of the x-axis labels run into each other
                    /*
                    barsvg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis2);
                    */

                    barsvg.append("g")
                        .attr("class", "y axis")
                        .call(yAxis2)
                        .append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", ".71em")
                        .style("text-anchor", "end");
                        //.text("Funding");
    
                    barsvg.selectAll(".bar")
                        .data(bardataTop5)
                        .enter().append("rect")
                        .style("fill", function(d) {
                          return "steelblue";
                        })
                        .attr("x", function(d) { return x(d.Industry); })
                        .attr("width", x.rangeBand())
                        .attr("y", function(d) { return y(d.Funding); })
                        .attr("height", function(d) { return height - y(d.Funding); })
                        .on("mouseover", function(d, i) {
                            d3.select(this).attr("class", "selected");
                            bartooltip.transition()
                                    .duration(200)
                                    .style("opacity", .9);

                            format = d3.format("0,000");
                            displayFunding = format(d.Funding);

                            bartooltip.html(d.Industry + "<br />$" + displayFunding)
                                    .style("left", (d3.event.pageX + 10) + "px")
                                    .style("top", (d3.event.pageY - 150) + "px");
                        })
                        .on("mouseout", function(d, i) {
                            d3.select(this).attr("class", "notselected");
                            bartooltip.transition()
                                 .duration(500)
                                 .style("opacity", 0);
                        })
                        .on("mousemove", function(d, i) {
                            d3.select(this).attr("class", "selected");
                        });

                    barsvg.append("g")
                        .append("text")
                        .attr("id", "top5label")
                        .attr("x", (width / 2) )
                        .attr("y", 0 - (margin.top / 4) + 20)
                        .attr("text-anchor", "middle")  
                        .style("font-size", "20px") 
                        .text("Top 5 Industries");

                } else {

                    errortext = barsvg.append("g")
                        .append("text")
                        .style("font-size", "20px")
                        .attr("x", -50)
                        .attr("y", 200)
                        .text("");

                    errortext.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "1.2em")
                        .text("No data for ");

                    errortext.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "1.2em")
                        .text(agencySet);

                    errortext.append("tspan")
                        .attr("x", 0)
                        .attr("dy", "1.2em")
                        .text("for year " + yearSet);

                }

            }

            function drawLinechart() {

                var linedata = new Array();

                // clear the chart
                d3.select("#linechart").selectAll("*").remove();

                // select just the data we want
                for (var i = 0; i < findata.length; i++) {
                    if (findata[i].industry == "ALL") {
                        if (findata[i].locality == "ALL") {
                            if (findata[i].agency == agencySet) {

                                industry = findata[i].industry;
                                locality = findata[i].locality;
                                agency = findata[i].agency;
                                year = findata[i].year;
                                funding = +findata[i].funding;
                        
                                lineobj = { "Industry" : industry, "Funding" : funding, "Locality" : locality, "Year" : year, "Agency" : agency };
                                linedata[linedata.length] = lineobj;
                            }
                        }
                    }
                }

                //console.log(linedata.length);

                linedata.sort(function(a, b) {
                    return a.Year - b.Year;
                });

                // Set the ranges
                var x = d3.scale.linear().range([0, upperchartwidth]);
                var y = d3.scale.linear().range([upperchartheight, 0]);
                
                // Define the axes
                var xAxis = d3.svg.axis().scale(x)
                    .orient("bottom").ticks(5, "0000");
                
                var yAxis = d3.svg.axis().scale(y)
                    .orient("left").ticks(3, "$,.0f");

                // Define the line
                var line = d3.svg.line()
                    .x(function(d) { return x(d.Year); })
                    .y(function(d) { return y(d.Funding); });

                yearmin = d3.min(linedata, function(d) { return +d.Year; }) - 1;
                yearmax = d3.max(linedata, function(d) { return +d.Year; }) + 2;

                // Scale the range of the data
                x.domain( [ yearmin, yearmax ] );
                y.domain([0, d3.max(linedata, function(d) { return d.Funding; })]);
              
                // Add the line path
                linesvg.append("path")
                    .datum(linedata)
                    .attr("class", "line")
                    .attr("d", line);
                
                // Add the X Axis
                linesvg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + upperchartheight + ")")
                    .call(xAxis);
                
                // Add the Y Axis
                /*
                linesvg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);
                */

                var parseDate = d3.time.format("%d-%b-%y").parse,
                    bisectDate = d3.bisector(function(d) { return d.Year; }).left,
                    formatValue = d3.format(",.2f"),
                    formatCurrency = function(d) { return "$" + formatValue(d); };

                var focus = linesvg.append("g")
                    .attr("class", "focus")
                    .style("display", "none");

                focus.append("circle")
                    .attr("r", 4.5);

                focus.append("text")
                    .attr("x", 9)
                    .attr("dy", ".35em");

                linesvg.append("rect")
                    .attr("class", "overlay")
                    .attr("width", upperchartwidth)
                    .attr("height", upperchartheight)
                    .on("mouseover", function() { focus.style("display", null); })
                    .on("mouseout", function() { focus.style("display", "none"); })
                    .on("mousemove", mousemove);

                function mousemove() {

                    //console.log(linedata[i - 1]);
                    //console.log(linedata[i]);

                    var x0 = x.invert(d3.mouse(this)[0]),
                        i = bisectDate(linedata, x0, 1),
                        d0 = linedata[i - 1],
                        d1 = linedata[i],
                        d = x0 - d0.Year > d1.Year - x0 ? d1 : d0;
                    focus.attr("transform", "translate(" + x(d.Year) + "," + y(d.Funding) + ")");
                    focus.select("text").text(formatCurrency(d.Funding));
                }
                
            }
                
        });
         
    });



</script>

</body>
</html>

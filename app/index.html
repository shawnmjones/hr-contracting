<!DOCTYPE html>
<html>
<head>
<title>Federal Contracting in Hampton Roads</title>
<meta charset="utf-8">
<style>

    .selected {
        opacity: 0.7;
    }

    .subunit-boundary {
        fill: none;
        stroke: #000000;
        stroke-width: 1px;
        stroke-dasharray: 0,1;
        stroke-linejoin: round;
    }

    .subunit-label {
        fill: #fff;
        font-size: 12px;
        font-weight: 300;
        text-anchor: middle;
        text-shadow:
          -2px 0px 0 #000,
          0px -2px 0 #000,
          0px 2px 0 #000,
          2px 0px 0 #000;
    }

    .tooltip {
        position: absolute;
        width: 220px;
        height: 40px;
        pointer-events: none;
        background-color: #ffffcc;
        font-family: Helvetica, Sans;
        text-align: center;
    }

    body {
        font-family: Helvetica, Sans;
    }

</style>
</head>

<body>
<h1>Federal Contracting in Hampton Roads</h1>
<h2>by Shawn Jones and Valentina Neblitt-Jones</h2>

<script src="libs/jquery/jquery-1.11.2.min.js"></script>
<script src="libs/d3/d3.v3.min.js"></script>
<script src="libs/topojson/topojson.v1.min.js"></script>
<script src="libs/colorbrewer/colorbrewer.js"></script>
<script>

    var formBlock = d3.select("body").append("p").append("form").attr("id", "axes");

    var yearoptions = formBlock.append("label").text("Year")
      .append("select").attr("id", "year").attr("class", "yearSelector");
    
    formBlock.append("br");
    
    var agencyoptions = formBlock.append("label").text("Agency")
      .append("select").attr("id", "agency").attr("class", "agencySelector");

    var width   = 575,
        height  = 468;

    var projection = d3.geo.albers()
                        .center([0, 36.85])
                        .rotate([76.5, 0])
                        .parallels([36.5, 37.5])
                        .scale(24000)
                        .translate([360, 334]);

    var path = d3.geo.path()
                .projection(projection);


    var cpsvg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("style", "background-color: #eeeeee");
//                .attr("style", "background-color: #deebf7");

    var barsvg = d3.select("body").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("style", "background-color: light-blue");

    // add the tooltip area to the webpage
    var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    var years = new Array(); 
    var agencies = new Array();

    d3.json("data/maps/hrCounties-topo.json", function(error1, hr) {
        if (error1) return console.error(error1);

        // d3.csv("data/financials/" + window.year + "-" + window.agency + ".csv", mapdata) {
        d3.csv("data/financials/financials.csv", function(error2, findata) {
            if (error2) return console.error(error2);

            console.log("inside function loading data");
            console.log(hr);
            console.log(findata);

            // intialize funding and color
            for (var j = 0; j < hr.objects.hrCounties.geometries.length; j++) {
                hr.objects.hrCounties.geometries[j].properties.funding = 0; 
                //hr.objects.hrCounties.geometries[j].properties.color = "#666666";
                hr.objects.hrCounties.geometries[j].properties.color = "#edf8e9";
            }

            yearSet = "2014";
            agencySet = "ALL";

            // initialize drop downs
            for (var i = 0; i < findata.length; i++) {

                if (jQuery.inArray(findata[i].year, years) === -1) {
                    years[years.length] = findata[i].year;
                }

                if (jQuery.inArray(findata[i].agency, agencies) === -1) {
                    agencies[agencies.length] = findata[i].agency;
                }

            }

            // sort the years
            years.sort().reverse();
            agencies.sort();

            console.log(agencies);

            for (var i = 0; i < years.length; i++) {
                yearoptions.append("option").text(years[i])
                    .attr("value", years[i]).attr("selected"); 
            }

            for (var i = 0; i < agencies.length; i++) {
                agencyoptions.append("option").text(agencies[i])
                    .attr("value", agencies[i]).attr("selected");
            }

            var agencyChange = function(d, id) {
                agencySet = d3.event.target.value; 
                drawChoropleth();
            }

            var yearChange = function(d, id) {
                yearSet = d3.event.target.value; 
                drawChoropleth();
            }

            d3.select("#agency").on("change", agencyChange);
            d3.select("#year").on("change", yearChange);

            drawChoropleth();
            drawBarchart();

            function fetchColor(value) {

                if (value < 100000) {
                    color = "#edf8e9";
                } else if (value < 500000) { 
                    color = "#bae4b3";
                } else if (value < 2000000) {
                    color = "#74c476";
                } else if (value < 8000000) {
                    color = "#31a354";
                } else {
                    color = "#006d2c";
                }

                return color;
            }

            function drawChoropleth() {

                // initialize all values to 0
                for (var j = 0; j < hr.objects.hrCounties.geometries.length; j++) {
                    hr.objects.hrCounties.geometries[j].properties.funding = 0;    
                }

                // set all funding and color for localities in choropleth
                for (var i = 0; i < findata.length; i++) {
                    for (var j = 0; j < hr.objects.hrCounties.geometries.length; j++) {
    
                        if (findata[i].industry == "ALL") { 
                            if (findata[i].locality != "ALL") {
    
                                if (findata[i].year == yearSet) {
                                   
                                    if (findata[i].agency == agencySet) {
    
                                        if (findata[i].locality == hr.objects.hrCounties.geometries[j].properties.name) {
                                            hr.objects.hrCounties.geometries[j].properties.funding = findata[i].funding; 
                                            break; // stop since we made our match
                                        }
                                    }
    
                                }
                            }
                        }
                    }
                }

    
                var subunits = cpsvg.selectAll(".subunit")
                    .data(topojson.feature(hr, hr.objects.hrCounties).features)
                    .enter().append("path")
                    .attr("style", function(d) {
                            return "fill:" + fetchColor(d.properties.funding);
                        })
                    .attr("d", path)
                    .on("mouseover", function(d, i) {
                        d3.select(this).attr("class", "selected");
                        tooltip.transition()
                                .duration(200)
                                .style("opacity", .9);

                        format = d3.format("0,000");
                        displayFunding = format(d.properties.funding);
    
                        tooltip.html(d.properties.name + "<br />$" + displayFunding)
                             .style("left", (d3.event.pageX + 10) + "px")
                             .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d, i) {
                        d3.select(this).attr("class", function(d) { return "subunit" + d.id; })
                        tooltip.transition()
                             .duration(500)
                             .style("opacity", 0);
                    })
                    .on("mousemove", function(d, i) {
                        d3.select(this).attr("class", "selected");
                    })
                    .on("click", function(d, i) {
                        window.alert("You clicked on " + d.properties.name);
                    });
       
                // create the boundaries
                cpsvg.append("path")
                    .datum(topojson.mesh(hr, hr.objects.hrCounties), function (a, b) { return a!=b; })
                    .attr("d", path)
                    .attr("class", "subunit-boundary");

                colors = d3.scale.ordinal()
                    .domain( [ "< $100,000", "$100,000 - $500,000", "$500,000 - $2,000,000", "$2,000,000 - $8,000,000", "> $8,000,000" ] )
                    .range(colorbrewer.Greens[5]);

                var legend = cpsvg.selectAll(".legend")
                    .data( colors.domain() )
                    .enter().append("g")
                    .attr("class", "legend")
                    .attr("transform", function(d, i) {
                        return "translate(-369," + (i+1) * 20 + ")"; }
                        );

                legend.append("rect")
                    .attr("x", width - 18)
                    .attr("width", 18)
                    .attr("height", 18)
                    .style("fill", colors );


                // draw legend text
                legend.append("text")
                    .attr("x", width - 24)
                    .attr("y", 9)
                    .attr("dy", ".35em")
                    .style("text-anchor", "end")
                    .text(function(d) { return d; });

            }

            function drawBarchart() {

            }

        });
         
    });

</script>

</body>
</html>
